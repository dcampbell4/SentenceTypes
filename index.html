<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grammar Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #95D5B2;
            color: #081C15;
        }
        .text-dark-green {
            color: #081C15;
        }
        .bg-mint {
            background-color: #52B788;
        }
        .border-mint {
            border-color: #52B788;
        }
        .focus\:ring-mint:focus {
            --tw-ring-color: #52B788;
        }
        .hover\:bg-mint-light:hover {
            background-color: #8ce3b7;
        }
        .bg-green-500 {
            background-color: #52B788;
        }
    </style>
</head>
<body class="p-4 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-2xl bg-white p-6 md:p-8 rounded-xl shadow-lg border border-gray-200">
        <h1 class="text-3xl font-bold text-center text-dark-green mb-6">Grammar Practice</h1>
        <p class="text-center text-dark-green mb-6">Select a topic from the dropdown menu to start your exercises.</p>

        <!-- Topic Selection Dropdown -->
        <div class="mb-8">
            <label for="topic-select" class="block text-dark-green font-medium mb-2">Choose a Topic:</label>
            <select id="topic-select" class="w-full p-3 rounded-lg border border-mint focus:outline-none focus:ring-2 focus:ring-mint transition-all duration-200 cursor-pointer">
                <option value="" disabled selected>-- Select a topic --</option>
            </select>
        </div>

        <!-- Exercises Container -->
        <div id="exercises-container" class="space-y-8">
            <!-- Exercises will be dynamically inserted here -->
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden text-center mt-8">
            <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-current border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]" role="status">
                <span class="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]">Loading...</span>
            </div>
            <p class="mt-2 text-dark-green">Checking your answer with Gemini...</p>
        </div>
    </div>

    <script>
        const exercisesData = {
            "Complex Sentences": [
                {
                    type: "multiple-choice",
                    question: "Identify the dependent clause: The mailman wouldn't deliver our mail after my dog bit him in the leg.",
                    options: ["after my dog bit him in the leg.", "The mailman wouldn't deliver our mail", "after my dog", "The mailman wouldn't deliver"]
                },
                {
                    type: "multiple-choice",
                    question: "Identify the subordinate conjunction: Because she didn't say, 'Mother may I?' she had to start over.",
                    options: ["Because", "she didn't say", "she had to start over", "start over"]
                },
                {
                    type: "multiple-choice",
                    question: "Combine the two sentences into a complex sentence: I had to go to the dentist. My back tooth started to hurt.",
                    options: ["I had to go to the dentist because my back tooth started to hurt.", "My back tooth started to hurt, so I had to go to the dentist.", "I had to go to the dentist, and my back tooth started to hurt.", "My back tooth started to hurt and I had to go to the dentist."]
                },
                {
                    type: "multiple-choice",
                    question: "Identify the dependent clause: Before you accuse someone of stealing your pencil, make sure it isn't just lost.",
                    options: ["Before you accuse someone of stealing your pencil", "make sure it isn't just lost", "accuse someone", "make sure"]
                },
                {
                    type: "multiple-choice",
                    question: "Identify the dependent clause: While some were fishing, others were hiking.",
                    options: ["While some were fishing", "others were hiking", "were fishing", "some were fishing"]
                }
            ],
            "Sentence Combining": [
                {
                    type: "writing",
                    prompt: "Combine the sentences using shared words: The high school band gave a concert. It lasted for an hour."
                },
                {
                    type: "multiple-choice",
                    question: "Combine the sentences using a phrase: The Battling Butterflies won the championship. They are my sister's softball team.",
                    options: ["The Battling Butterflies, my sister's softball team, won the championship.", "My sister's softball team, the Battling Butterflies, won the championship.", "The Battling Butterflies, who are my sister's softball team, won the championship.", "The Battling Butterflies won the championship, which is my sister's softball team."]
                },
                {
                    type: "multiple-choice",
                    question: "Combine the sentences into a compound sentence: We wanted to see the movie. It was sold out.",
                    options: ["We wanted to see the movie, but it was sold out.", "We wanted to see the movie, so it was sold out.", "We wanted to see the movie and it was sold out.", "Because the movie was sold out, we wanted to see it."]
                },
                {
                    type: "writing",
                    prompt: "Combine the sentences into a complex sentence: Our football captain rings the victory bell. He rings it whenever we win a game."
                },
                {
                    type: "writing",
                    prompt: "Combine the sentences using shared words: My mom made a big pizza. It was for the whole team."
                }
            ],
            "Compound-Complex Sentences": [
                {
                    type: "multiple-choice",
                    question: "Identify the type of sentence: Because the dog was tired, he laid down, and he fell asleep quickly.",
                    options: ["Compound-Complex Sentence", "Simple Sentence", "Compound Sentence", "Complex Sentence"]
                },
                {
                    type: "writing",
                    prompt: "Combine the sentences: The sun was shining, and the birds were singing. (when we went outside)"
                },
                {
                    type: "multiple-choice",
                    question: "Identify the independent and dependent clauses in this sentence: Although she was tired, she studied all night, and she passed the exam with flying colors.",
                    options: ["Independent: she studied all night, she passed the exam with flying colors. Dependent: Although she was tired.", "Independent: she was tired, she studied all night. Dependent: she passed the exam with flying colors", "Independent: she studied all night. Dependent: Although she was tired, and she passed the exam with flying colors", "All are independent clauses."]
                },
                {
                    type: "writing",
                    prompt: "Combine the sentences: The movie was exciting, and the popcorn was delicious. (after we got our tickets)"
                }
            ],
            "Sentence Types Quiz": [
                {
                    type: "multiple-choice",
                    question: "Identify the sentence type: The birds were playing in our pool.",
                    options: ["Simple Sentence", "Complex Sentence", "Compound Sentence", "Compound-complex Sentence"]
                },
                {
                    type: "multiple-choice",
                    question: "Identify the sentence type: We were hungry, but dinner wasn't ready yet.",
                    options: ["Compound Sentence", "Simple Sentence", "Complex Sentence", "Compound-complex Sentence"]
                },
                {
                    type: "multiple-choice",
                    question: "Identify the sentence type: We had to stop swimming because it started to rain.",
                    options: ["Complex Sentence", "Simple Sentence", "Compound Sentence", "Compound-complex Sentence"]
                },
                {
                    type: "multiple-choice",
                    question: "Identify the sentence type: We have fun whenever my cousins come over, but they won't visit us until they sell their house.",
                    options: ["Compound-complex Sentence", "Simple Sentence", "Complex Sentence", "Compound Sentence"]
                },
                {
                    type: "multiple-choice",
                    question: "Identify the sentence type: Ken mowed the lawn, and Jeff washed the car.",
                    options: ["Compound Sentence", "Simple Sentence", "Complex Sentence", "Compound-complex Sentence"]
                },
                {
                    type: "multiple-choice",
                    question: "Identify the sentence type: The beautiful dancer walked across the stage to accept the flowers from the director.",
                    options: ["Simple Sentence", "Complex Sentence", "Compound Sentence", "Compound-complex Sentence"]
                },
                {
                    type: "multiple-choice",
                    question: "Identify the sentence type: There is a big box of old baby clothes in the back of the closet.",
                    options: ["Simple Sentence", "Complex Sentence", "Compound Sentence", "Compound-complex Sentence"]
                },
                {
                    type: "multiple-choice",
                    question: "Identify the sentence type: The boys played while the girls painted, and everyone had a good time.",
                    options: ["Compound-complex Sentence", "Simple Sentence", "Complex Sentence", "Compound Sentence"]
                }
            ]
        };

        const topicSelect = document.getElementById('topic-select');
        const exercisesContainer = document.getElementById('exercises-container');
        const loadingIndicator = document.getElementById('loading-indicator');

        // Populate the dropdown menu
        function populateTopics() {
            for (const topic in exercisesData) {
                const option = document.createElement('option');
                option.value = topic;
                option.textContent = topic;
                topicSelect.appendChild(option);
            }
        }

        // Display exercises for the selected topic
        function displayExercises(topic) {
            exercisesContainer.innerHTML = ''; // Clear previous exercises
            const exercises = exercisesData[topic];

            exercises.forEach((exercise, index) => {
                const exerciseCard = document.createElement('div');
                exerciseCard.className = 'bg-gray-50 p-6 rounded-xl shadow-inner border border-mint';

                const questionText = `<p class="text-lg font-semibold text-dark-green mb-4">${index + 1}. ${exercise.question || exercise.prompt}</p>`;
                
                if (exercise.type === "multiple-choice") {
                    exerciseCard.innerHTML = `
                        ${questionText}
                        <div class="options-container grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                    `;
                    const optionsContainer = exerciseCard.querySelector('.options-container');
                    const shuffledOptions = shuffleArray(exercise.options);
                    shuffledOptions.forEach(option => {
                        const button = document.createElement('button');
                        button.textContent = option;
                        button.className = 'w-full text-left p-3 rounded-lg border border-mint bg-white text-dark-green font-medium hover:bg-mint-light transition-colors duration-200';
                        button.onclick = () => handleMultipleChoiceAnswer(button, option, exercise.options[0], optionsContainer);
                        optionsContainer.appendChild(button);
                    });
                } else if (exercise.type === "writing") {
                    exerciseCard.innerHTML = `
                        ${questionText}
                        <textarea class="w-full p-3 rounded-lg border border-mint focus:outline-none focus:ring-2 focus:ring-mint mb-4" rows="3" placeholder="Write your sentence here..."></textarea>
                        <button class="w-full p-3 rounded-lg bg-mint text-white font-bold hover:bg-mint-light transition-colors duration-200">Check Answer</button>
                        <div class="feedback-container mt-4"></div>
                    `;
                    const submitButton = exerciseCard.querySelector('button');
                    const textArea = exerciseCard.querySelector('textarea');
                    const feedbackContainer = exerciseCard.querySelector('.feedback-container');
                    submitButton.onclick = () => checkWritingAnswer(textArea.value, exercise.prompt, feedbackContainer, submitButton);
                }

                exercisesContainer.appendChild(exerciseCard);
            });
        }

        // Handle the user's multiple-choice answer selection
        function handleMultipleChoiceAnswer(clickedButton, selectedOption, correctAnswer, optionsContainer) {
            const allButtons = optionsContainer.querySelectorAll('button');
            allButtons.forEach(btn => btn.disabled = true);

            if (selectedOption === correctAnswer) {
                clickedButton.classList.remove('bg-white', 'hover:bg-mint-light');
                clickedButton.classList.add('bg-green-500', 'text-white');
            } else {
                clickedButton.classList.remove('bg-white', 'hover:bg-mint-light');
                clickedButton.classList.add('bg-red-500', 'text-white');
                allButtons.forEach(btn => {
                    if (btn.textContent === correctAnswer) {
                        btn.classList.remove('bg-white');
                        btn.classList.add('bg-green-500', 'text-white');
                    }
                });
            }
        }

        // Check a writing-based answer using Gemini API
        async function checkWritingAnswer(studentAnswer, originalPrompt, feedbackContainer, submitButton) {
            feedbackContainer.innerHTML = '';
            loadingIndicator.classList.remove('hidden');
            submitButton.disabled = true;

            const systemPrompt = "You are a friendly and helpful grammar tutor. Provide a brief, supportive, and clear explanation of whether the student's sentence is a correct answer to the prompt. If it is incorrect, explain why and provide a corrected example. The feedback should be encouraging and simple for a student to understand.";
            const userQuery = `Original question: "${originalPrompt}". Student's answer: "${studentAnswer}".`;
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let response;
            let retryCount = 0;
            const maxRetries = 3;

            while (retryCount < maxRetries) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userQuery }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                        })
                    });

                    if (response.ok) {
                        break; // Success, exit the retry loop
                    } else if (response.status === 429) {
                        // Too many requests, retry with exponential backoff
                        const delay = Math.pow(2, retryCount) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        retryCount++;
                    } else {
                        // Non-429 error, don't retry, just break
                        console.error('API call failed with status:', response.status);
                        break;
                    }
                } catch (error) {
                    console.error('API call failed:', error);
                    break;
                }
            }

            loadingIndicator.classList.add('hidden');
            submitButton.disabled = false;

            if (response && response.ok) {
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't provide feedback at this time.";
                feedbackContainer.innerHTML = `<p class="p-4 rounded-lg bg-gray-100 text-dark-green">${text}</p>`;
            } else {
                const errorText = `Oops! Something went wrong. Status: ${response?.status || 'Unknown'}. Please try again.`;
                feedbackContainer.innerHTML = `<p class="p-4 rounded-lg bg-red-100 text-red-700 font-bold">${errorText}</p>`;
            }
        }

        // Fisher-Yates shuffle algorithm for shuffling the options
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Event listener for the dropdown
        topicSelect.addEventListener('change', (event) => {
            const selectedTopic = event.target.value;
            if (selectedTopic) {
                displayExercises(selectedTopic);
            }
        });

        // Initialize the app on page load
        window.onload = populateTopics;
    </script>
</body>
</html>
